# previously called: standard_spa_pr.yml
name: Standard SPA PR (NPM)

on:
  workflow_call:
    inputs:
      fallback_runner:
        description: "If true will levarege ubuntu-latest, otherwise will fall back to the J1 in-house runner"
        default: true
        type: boolean
      use_validate:
        description: "Run test, in most case we want this"
        default: true
        type: boolean
      use_chromatic:
        description: "Run VRT Storybook tests with chromatic"
        default: false
        type: boolean
      use_magic_url:
        description: "Deploy to dev via a query param, required for normal SPAs"
        default: true
        type: boolean
      use_e2e:
        description: "Run E2E test, in most case we want this"
        type: boolean
      e2e_filter_tags:
        description: "Tests will be filtered based on the tags defined here"
        type: string  
      e2e_containers:
        description: "The number of tests that you want Cypress to run in parallel (ex. 1, 2, 3, ...)"
        type: string
        default: '["1"]'
      e2e_pass_on_error:
        description: "Pass the workflow even if the E2E test fail"
        type: boolean
        default: false
      e2e_artemis_config_path:
        description: 'Used to determine the path to the artemis config file'
        type: string
        default: 'cypress/artemis-config.yaml'
      spec_to_run:
        description: 'Used to determine which test to run'
        type: string
        default: 'cypress/e2e/**/*.feature'
      magic_url_route: 
        description: 'The relative route the magic url should go to'
        type: string
        default: '/'
    secrets:
      NPM_TOKEN:
        description: "A J1 npm.com Publish token"
        required: true
      CHROMATIC_PROJECT_TOKEN:
        description: "The Chromatic API token"
        required: false
      AWS_ROLE:
        description: "J1 AWS role with deploy permissions to dev"
        required: false
      AWS_REGION:
        description: "The current region of the dev env"
        required: false
      AWS_APPS_BUCKET:
        description: "What bucket to deploy the magic url"
        required: false
      CYPRESS_RECORD_KEY:
        description: "The record key associated with the project in Cypress"
        required: false
      CYPRESS_PROJECT_ID:
        description: "The project ID associated with the project in Cypress"
        required: false
      CYPRESS_PASSWORD:
        description: "The password of the E2E username"
        required: false

env:
  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

# Permissions needed to push the artifact to the S3 bucket and show the status in the PR.
permissions:
  id-token: write
  contents: read
  pull-requests: write
  statuses: write
  
jobs:
  migration_number:
    runs-on: ${{ (inputs.fallback_runner && 'ubuntu-latest') || fromJson('["jupiterone-dev", "arm64"]') }}
    outputs:
      migration: ${{ steps.migration_number.outputs.migration }}
    steps:
      - uses: actions/checkout@v2
      - id: migration_number
        uses: ./.github/actions/frontend/runtime/migration_number

  