name: Standard SPA PR (NPM)

on:
  workflow_call:
    inputs:
      working_directory:
        description:
          'The working directory from which to run the workflow commands'
        required: false
        type: string
        default: '.'
      runs_on:
        description: "Deprecated noop - To be removed"
        type: string
      default_runner:
        default: "['jupiterone-dev', 'arm64']"
        type: string
      e2e_runner:
        default: "['jupiterone-dev', 'amd64']"
        type: string
      github_runner:
        default: "ubuntu-latest"
        type: string
      use_github_runner:
        description: "If true will levarege ubuntu-latest, otherwise will fall back to the J1 in-house runner"
        default: false
        type: boolean
      use_validate:
        description: "Run test, in most case we want this"
        required: true
        type: boolean
      use_chromatic:
        description: "Run VRT Storybook tests with chromatic"
        required: true
        type: boolean
      use_magic_url:
        description: "Deploy to dev via a query param, required for normal SPAs"
        required: true
        type: boolean
      use_e2e:
        description: "Run E2E test, in most case we want this"
        type: boolean
      use_e2e_trigger:
        description: "Trigger E2E tests in other repos"
        type: boolean
      e2e_filter_tags:
        description: "Tests will be filtered based on the tags defined here"
        type: string
      repos_to_test:
        description: "Kick off a n+ spec files within n+ repos"
        type: string
      e2e_containers:
        description: "The number of tests that you want Cypress to run in parallel (ex. 1, 2, 3, ...)"
        type: string
        default: '["1"]'
      e2e_pass_on_error:
        description: "Pass the workflow even if the E2E test fail"
        type: boolean
        default: true
      e2e_artemis_config_path:
        description: 'Used to determine the path to the artemis config file'
        type: string
        default: 'cypress/artemis-config.yaml'
      external_pr_number:
        description: 'Used by the e2e_trigger to pass in the PR number associated with the PR that triggered the flow'
        type: string
      external_pr_title:
        description: 'Used by the e2e_trigger to give builds in Cypress the correct title associated with the PR that triggered the flow'
        type: string
      external_pr_branch:
        description: 'Used by the e2e_trigger to give builds in Cypress the correct branch name'
        type: string
      external_pr_author:
        description: 'Used by the e2e_trigger to give builds in Cypress the correct author name associated with the owner of the PR'
        type: string
      external_pr_sha:
        description: 'Used by the e2e_trigger to give builds in Cypress the correct SHA associated with the PR that triggered the flow'
        type: string
      external_pr_repo_name:
        description: 'Used by the e2e_trigger to tag builds in Cypress with the appropriate repo name (used to associate a repo with a test run)'
        type: string
      externally_triggered:
        description: 'True if E2E tests are triggered from another repo'
        default: false
        type: boolean
      spec_to_run:
        description: 'Used to determine which test to run'
        type: string
        default: 'cypress/e2e/**/*.feature'
      magic_url_route: 
        description: 'The relative route the magic url should go to'
        type: string
        default: '/'
    secrets:
      NPM_TOKEN:
        description: "A J1 npm.com Publish token"
        required: true
      CHROMATIC_PROJECT_TOKEN:
        description: "The Chromatic API token"
        required: false
      AWS_ROLE:
        description: "J1 AWS role with deploy permissions to dev"
        required: false
      AWS_REGION:
        description: "The current region of the dev env"
        required: false
      AWS_APPS_BUCKET:
        description: "What bucket to deploy the magic url"
        required: false
      CYPRESS_RECORD_KEY:
        description: "The record key associated with the project in Cypress"
        required: false
      CYPRESS_PROJECT_ID:
        description: "The project ID associated with the project in Cypress"
        required: false
      CYPRESS_PASSWORD:
        description: "The password of the E2E username"
        required: false
      E2E_AUTO:
        description: "A J1 token for kicking off cypress tests"
        required: false

jobs:
  create-shared-vars:
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    name: Creates shared variables used by the the jobs below based on whether the jobs were triggered by another repo or internally
    runs-on: ${{ inputs.use_github_runner && inputs.github_runner || fromJson(inputs.default_runner) }}
    timeout-minutes: 15
    outputs:
      groupId: ${{ steps.externalTrigger.outputs.groupId }}
      e2eJobDescription: ${{ steps.externalTrigger.outputs.e2eJobDescription }}
      usersCount: ${{ steps.userCount.outputs.usersCount }}
    steps:
      - id: userCount
        run: |
          echo "usersCount=$(echo '${{ inputs.e2e_containers }}' | jq '. | length')" >> $GITHUB_OUTPUT
      - id: externalTrigger
        run: |
          if [[ ${{ inputs.externally_triggered }} == true ]]; then
            echo "groupId=$(date +'%Y-%m-%d %H:%M:%S %s')" >> $GITHUB_OUTPUT
            echo "e2eJobDescription=external repo ${{ inputs.external_pr_repo_name }} - ${{ inputs.external_pr_branch }}" >> $GITHUB_OUTPUT 
          else
            echo "groupId=${{ github.workflow }}-${{ github.event.repository.name }}-${{ github.event.pull_request.number || github.ref }}" >> $GITHUB_OUTPUT
            echo "e2eJobDescription=${{ github.event.repository.name }}" >> $GITHUB_OUTPUT
          fi

  validate:
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    name: Validate
    runs-on: ${{ inputs.use_github_runner && inputs.github_runner || fromJson(inputs.default_runner) }}
    timeout-minutes: 15
    concurrency:
      group: validate-${{ needs.create-shared-vars.outputs.groupId }}
      cancel-in-progress: true
    needs: [create-shared-vars]
    if: ${{ inputs.use_validate }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - run: npm ci

      - name: Validate
        run: npm run validate:ci
      # Check if we should skip validating runtime types
      - name: Check For Skip
        run: |
          if [[ $(git log -2 --pretty=format:'%s' | grep "\[skip remote-type-check\]")  ]]; then 
            echo "HAS_SKIP=true" >> $GITHUB_ENV
          fi
      # Validate runtime types (if applicable)
      - name: Validate Runtime Modules Types
        run: |
          if [[ -f "node_modules/@jupiterone/web-runtime-modules/cli/testInterfaceRuntimeModules.js" ]]; then
            npx testInterfaceRuntimeModules;
            echo "No breaking changes found";
          else
            echo "Skipping, @jupiterone/web-runtime-modules not installed";
          fi
        if: ${{ !env.HAS_SKIP }}

  chromatic-deployment:
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    runs-on: ${{ inputs.use_github_runner && inputs.github_runner || fromJson(inputs.default_runner) }}
    timeout-minutes: 15
    concurrency:
      group: chromatic-deployment-${{ needs.create-shared-vars.outputs.groupId }}
      cancel-in-progress: true
    needs: [create-shared-vars]
    if: ${{ inputs.use_chromatic }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - run: npm ci

      - name: Publish to Chromatic
        uses: chromaui/action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          onlyChanged: true
          exitOnceUploaded: true

  deploy_magic_url:
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    name: Deploy Magic URL
    runs-on: ${{ inputs.use_github_runner && inputs.github_runner || fromJson(inputs.default_runner) }}
    timeout-minutes: 15
    concurrency:
      group: deploy-magic-url-${{ needs.create-shared-vars.outputs.groupId }}
      cancel-in-progress: true
    needs: [create-shared-vars]
    if: ${{ inputs.use_magic_url }}
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - run: npm ci

      - name: Building
        run: npm run build
      - name: configure aws credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: ${{ secrets.AWS_ROLE }}
          role-session-name:
            ${{ github.event.repository.name }}-magic-url-role-session
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Deploy
        # This bucket file location is static and editing it will break the Magic URL
        run: |
          [ -f deploy/dist/${{ github.event.repository.name }}-remote-types.tgz ] && mv deploy/dist/${{ github.event.repository.name }}-remote-types.tgz deploy/dist/remote-types.tgz
          aws s3 sync deploy/dist s3://${{ secrets.AWS_APPS_BUCKET }}/static/manual-deploy/${{ github.event.repository.name }}/PR-${{ github.event.number }}/

  magic_url:
    name: Post Magic URL
    runs-on: ${{ inputs.use_github_runner && inputs.github_runner || fromJson(inputs.default_runner) }}
    timeout-minutes: 1
    concurrency:
      group: magic-url-${{ needs.create-shared-vars.outputs.groupId }}
      cancel-in-progress: true
    if: ${{ inputs.use_magic_url }}
    needs: [create-shared-vars, deploy_magic_url]
    steps:
      - name: Return Magic URL
        uses: Sibz/github-status-action@v1
        with: 
          authToken: ${{ secrets.GITHUB_TOKEN }}
          state: 'success'
          context: 'Magic URL'
          description: "Use the 'Details' link to view this PR in dev"
          target_url: https://apps.dev.jupiterone.io${{ inputs.magic_url_route }}?magic=%7B%22${{ github.event.repository.name }}%22:%22PR-${{ github.event.pull_request.number }}%22%7D
          sha: ${{github.event.pull_request.head.sha || github.sha}}

  prepare_for_e2e_test:
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    name: Prepare For E2E Tests
    runs-on: ${{ inputs.use_github_runner && inputs.github_runner || fromJson(inputs.default_runner) }}
    timeout-minutes: 15
    concurrency:
      group: prepare-for-e2e-test-${{ needs.create-shared-vars.outputs.groupId }}
      cancel-in-progress: true
    needs: [create-shared-vars]
    # We need this job to run even if the magic url is skipped which occurs via the e2e_trigger.yml
    if: ${{ inputs.use_e2e || inputs.externally_triggered }}
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    outputs:
      artemisAccountName: ${{ steps.outputStep.outputs.artemisAccountName }}
      artemisAccountId: ${{ steps.outputStep.outputs.artemisAccountId }}
      # compact JSON of [{csrf:string,secret:string,subject:string},...]
      artemisUsers: ${{ steps.outputStep.outputs.artemisUsers }}
      # TODO: Remove via APP-11658
      artemisUsersLegacy: ${{ steps.outputStep.outputs.artemisUsersLegacy }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - run: npm ci
      - name: configure aws credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: ${{ secrets.AWS_ROLE }}
          role-session-name:
            ${{ github.event.repository.name }}-magic-url-role-session
          aws-region: us-east-1
      - name: update artemis config
        run: npx update-artemis-config --pathToArtemisConfig=${{ inputs.e2e_artemis_config_path }} --usersCount=${{ needs.create-shared-vars.outputs.usersCount }}
      - name: launch artemis
        run: npx artemis-launch -c tmp/artemis-config-updated.yaml --action=launch --outputFilename=artemis-run
      - id: outputStep
        # Use jq to extract the accountId and user sessions from the json file in a raw form
        run: |
          echo "artemisAccountName=$(jq -r .[0].metadata.accountName < artemis-run.json)" >> $GITHUB_OUTPUT
          echo "artemisAccountId=$(jq -r .[0].id < artemis-run.json)" >> $GITHUB_OUTPUT
          echo "artemisUsers=$(jq -c 'map((select(. | .type == "User")) | { tokenSecret: .metadata.token.tokenSecret, tokenCsrf: .metadata.token.tokenCsrf, groupName: .metadata.groupName })' < artemis-run.json)" >> $GITHUB_OUTPUT
          echo "artemisUsersLegacy=$(jq -c 'map((select(. | .metadata.type == "user-session")) | { secret: .metadata.secret, csrf: .metadata.csrf, subject: .metadata.subject })' < artemis-run.json)" >> $GITHUB_OUTPUT

  # Kicks off tests this repo
  run-e2e-tests:
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    name: Run E2E Tests for ${{ needs.create-shared-vars.outputs.e2eJobDescription }}
    runs-on: ${{ inputs.use_github_runner && inputs.github_runner || fromJson(inputs.e2e_runner) }}
    container:
      image: cypress/browsers:node18.12.0-chrome106-ff106
      options: --platform linux/amd64 --privileged
    timeout-minutes: 15
    if: |
      always()
      && !cancelled()
      && inputs.use_e2e
    needs: [create-shared-vars, magic_url, prepare_for_e2e_test]
    continue-on-error: ${{ inputs.e2e_pass_on_error }}
    strategy:
      # when one test fails, DO NOT cancel the other
      # containers, because this will kill Cypress processes
      # leaving Cypress Cloud hanging ...
      # https://github.com/cypress-io/github-action/issues/48 
      fail-fast: false
      matrix:
        # run copies of the current job in parallel
        containers: ${{ fromJson(inputs.e2e_containers) }}
        node: [18]
    concurrency:
      group: run-e2e-tests-${{ needs.create-shared-vars.outputs.groupId }}-${{ matrix.containers }}
      cancel-in-progress: true
    steps:
      - name: Log E2E Info
        run: echo "Running E2E test for PR with title of ${{ inputs.external_pr_title || github.event.pull_request.title }} and number being ${{ inputs.external_pr_number || github.event.pull_request.number }}. The following account will be used ${{ needs.prepare_for_e2e_test.outputs.artemisAccountName }} (${{ needs.prepare_for_e2e_test.outputs.artemisAccountId }}). The following matrix container is being used ${{ matrix.containers }}"
      - name: Log groupId
        run: echo "groupId - ${{ needs.create-shared-vars.outputs.groupId }}"
      - name: Log status of prepare_for_e2e_test job
        run: echo "prepare status - ${{ needs.prepare_for_e2e_test.result }}"
      # Fail the rest of the job if the prepare_for_e2e_test job failed (needed since we use always)
      - name: Check status of prepare_for_e2e_test job
        if: ${{ needs.prepare_for_e2e_test.result != 'success' }}
        run: exit 1
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - name: Cypress run
        id: cypress_run
        continue-on-error: true
        uses: cypress-io/github-action@v5
        timeout-minutes: 60
        with:
          record: true
          parallel: true
          group: PR
          ci-build-id: '${{ github.sha }}-${{ github.workflow }}-${{ github.event_name }}-${{ inputs.external_pr_number || github.event.pull_request.number }}'
          browser: chrome
          tag: ${{ inputs.external_pr_repo_name || github.event.repository.name }},${{ github.event_name }}
        env:
          # https://github.com/cypress-io/cypress/issues/25357#issuecomment-1426992422
          ELECTRON_EXTRA_LAUNCH_ARGS: '--disable-gpu'
          CYPRESS_BROWSER: chrome
          COMMIT_INFO_MESSAGE: ${{ inputs.external_pr_title || github.event.pull_request.title }}
          COMMIT_INFO_BRANCH: ${{ inputs.external_pr_branch }}
          COMMIT_INFO_AUTHOR: ${{ inputs.external_pr_author }}
          COMMIT_INFO_SHA: ${{ inputs.external_pr_sha }}
          CYPRESS_CONTAINER: ${{ matrix.containers }}
          CYPRESS_MAILINATOR_API_KEY: ${{ secrets.CYPRESS_MAILINATOR_API_KEY }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          CYPRESS_PROJECT_ID: ${{ secrets.CYPRESS_PROJECT_ID }}
          CYPRESS_PASSWORD: ${{ secrets.CYPRESS_PASSWORD }}
          CYPRESS_ENVIRONMENT_NAME: jupiterone-dev
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          PR_NUMBER: ${{ inputs.external_pr_number || github.event.pull_request.number }}
          REPO_NAME: ${{ inputs.external_pr_repo_name || github.event.repository.name }}
          SPEC: ${{ inputs.spec_to_run }}
          ACCOUNT: ${{ needs.prepare_for_e2e_test.outputs.artemisAccountName }}
          ACCOUNT_ID: ${{ needs.prepare_for_e2e_test.outputs.artemisAccountId }}
          # TODO: Remove via APP-11658
          USERS: ${{ needs.prepare_for_e2e_test.outputs.artemisUsers || needs.prepare_for_e2e_test.outputs.artemisUsersLegacy }}
          TAGS: ${{ inputs.e2e_filter_tags }}
      # We have to manually output an exit code of 0 to ensure the action passes if e2e_pass_on_error is true
      - name: Pass with failures
        if: ${{ inputs.e2e_pass_on_error }}
        run: exit 0
      - name: Set success vars
        if: ${{ contains(steps.cypress_run.outcome, 'success') }}
        run: |
          echo "TEST_STATUS_STATE=success" >> $GITHUB_ENV
          echo "TEST_STATUS_DESCRIPTION='E2E test passed'" >> $GITHUB_ENV
      - name: Set failure vars
        if: ${{ !contains(steps.cypress_run.outcome, 'success') }}
        run: |
          echo "TEST_STATUS_STATE=failure" >> $GITHUB_ENV
          echo "TEST_STATUS_DESCRIPTION='E2E test failed'" >> $GITHUB_ENV
      - name: E2E Test Status
        uses: Sibz/github-status-action@v1
        continue-on-error: ${{ inputs.e2e_pass_on_error }}
        with:
          authToken: ${{secrets.GITHUB_TOKEN}}
          context: 'E2E Test Status'
          description: ${{ env.TEST_STATUS_DESCRIPTION }}
          state: ${{ env.TEST_STATUS_STATE }}
          sha: ${{github.event.pull_request.head.sha || github.sha}}

  # Kicks off tests in other repos
  run-e2e-integration-tests:
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    runs-on: ${{ inputs.use_github_runner && inputs.github_runner || fromJson(inputs.default_runner) }}
    timeout-minutes: 60
    concurrency:
      group: validate-${{ needs.create-shared-vars.outputs.groupId }}
      cancel-in-progress: true
    if: ${{ inputs.use_e2e_trigger }}
    needs: [create-shared-vars, magic_url]
    strategy:
      matrix:
        repos: ${{ fromJson(inputs.repos_to_test) }}
    continue-on-error: ${{ inputs.e2e_pass_on_error }}
    steps:
      - uses: actions/checkout@v3
      - name: Log E2E Info
        run: echo "In the ${{ matrix.repos.repo.name }} repo, run the following test ${{ matrix.repos.repo.spec }}"
      - name: Get author name
        run: echo "COMMIT_INFO_AUTHOR=$(git show -s --pretty=%an)" >> $GITHUB_ENV
      - name: Trigger Workflow and Wait
        id: trigger_run
        continue-on-error: ${{ inputs.e2e_pass_on_error }}
        uses: convictional/trigger-workflow-and-wait@v1.6.5
        with:
          owner: JupiterOne
          repo: ${{ matrix.repos.repo.name }}
          github_token: ${{ secrets.E2E_AUTO }}
          workflow_file_name: e2e_trigger.yml
          propagate_failure: ${{ !inputs.e2e_pass_on_error }}
          client_payload: '{"spec_to_run":"${{ matrix.repos.repo.spec }}","external_pr_number":"${{ github.event.pull_request.number }}","external_pr_title":"${{ github.event.pull_request.title }}","external_pr_repo_name":"${{ github.event.repository.name }}","external_pr_branch":"${{ github.event.pull_request.head.ref }}","external_pr_author":"${{ env.COMMIT_INFO_AUTHOR }}","external_pr_sha":"${{ github.event.pull_request.base.sha }}"}'
      # We have to manually output an exit code of 0 to ensure the action passes if e2e_pass_on_error is true
      - name: Pass with failures
        if: ${{ inputs.e2e_pass_on_error }}
        run: exit 0
      - name: Set success vars
        if: ${{ steps.trigger_run.outcome }} == 'success'
        run: |
          echo "TEST_STATUS_STATE=success" >> $GITHUB_ENV
          echo "TEST_STATUS_DESCRIPTION='E2E test passed'" >> $GITHUB_ENV
      - name: Set failure vars
        if: ${{ steps.trigger_run.outcome }} != 'success'
        run: |
          echo "TEST_STATUS_STATE=failure" >> $GITHUB_ENV
          echo "TEST_STATUS_DESCRIPTION='E2E test failed'" >> $GITHUB_ENV
      - name: E2E Test Status
        uses: Sibz/github-status-action@v1
        continue-on-error: ${{ inputs.e2e_pass_on_error }}
        with:
          authToken: ${{secrets.GITHUB_TOKEN}}
          context: 'E2E Test Status'
          description: ${{ env.TEST_STATUS_DESCRIPTION }}
          state: ${{ env.TEST_STATUS_STATE }}
          sha: ${{github.event.pull_request.head.sha || github.sha}}
